generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model blue_point_history {
  id         Int                       @id @default(autoincrement())
  ranking_id Int
  user_id    Int
  month_key  DateTime
  reason     blue_point_history_reason
  created_at DateTime?                 @default(now())
  rankings   rankings                  @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      users                     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([ranking_id, user_id, month_key, reason])
  @@index([user_id])
}

model challenge_events {
  id           Int                         @id @default(autoincrement())
  challenge_id Int
  event_type   challenge_events_event_type
  payload      Json?
  created_at   DateTime?                   @default(now())
  created_by   Int?
  challenges   challenges                  @relation(fields: [challenge_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users        users?                      @relation(fields: [created_by], references: [id], onUpdate: NoAction)

  @@index([challenge_id])
  @@index([created_by])
}

model challenge_penalties {
  id           Int                            @id @default(autoincrement())
  challenge_id Int
  applies_to   challenge_penalties_applies_to
  positions    Int
  created_at   DateTime?                      @default(now())
  challenges   challenges                     @relation(fields: [challenge_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([challenge_id])
}

model challenges {
  id                                    Int                   @id @default(autoincrement())
  ranking_id                            Int
  challenger_id                         Int
  challenged_id                         Int
  scheduled_for                         DateTime
  accepted_at                           DateTime?
  declined_at                           DateTime?
  decline_reason                        String?
  played_at                             DateTime?
  result_reported_at                    DateTime?
  challenger_games                      Int?
  challenged_games                      Int?
  challenger_tiebreak                   Int?
  challenged_tiebreak                   Int?
  challenger_walkover                   Boolean?              @default(false)
  challenged_walkover                   Boolean?              @default(false)
  challenger_retired                    Boolean?              @default(false)
  challenged_retired                    Boolean?              @default(false)
  challenger_position_at_challenge      Int?
  challenged_position_at_challenge      Int?
  winner                                challenges_winner?
  notes                                 String?
  penalty_summary                       Json?
  cancelled_by_admin                    Boolean               @default(false)
  status                                challenges_status     @default(scheduled)
  round_id                              Int?
  created_at                            DateTime?             @default(now())
  updated_at                            DateTime?
  challenge_events                      challenge_events[]
  challenge_penalties                   challenge_penalties[]
  users_challenges_challenged_idTousers users                 @relation("challenges_challenged_idTousers", fields: [challenged_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_challenges_challenger_idTousers users                 @relation("challenges_challenger_idTousers", fields: [challenger_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rankings                              rankings              @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rounds                                rounds?               @relation(fields: [round_id], references: [id], onUpdate: NoAction)

  @@index([challenged_id])
  @@index([challenger_id])
  @@index([ranking_id])
  @@index([round_id])
}

model ranking_memberships {
  id                  Int      @id @default(autoincrement())
  ranking_id          Int
  user_id             Int
  position            Int?
  points              Int?     @default(0)
  is_blue_point       Boolean? @default(false)
  is_access_challenge Boolean  @default(false)
  is_locked           Boolean? @default(false)
  is_suspended        Boolean? @default(false)
  license_position    Int?
  rankings            rankings @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users               users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([ranking_id, user_id])
  @@index([user_id])
}

model collaborator_rankings {
  id         Int       @id @default(autoincrement())
  user_id    Int
  ranking_id Int
  created_at DateTime? @default(now())
  rankings   rankings  @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, ranking_id])
  @@index([ranking_id])
}

model ranking_snapshots {
  id            Int                             @id @default(autoincrement())
  ranking_id    Int
  round_month   DateTime
  snapshot_type ranking_snapshots_snapshot_type @default(start)
  user_id       Int
  position      Int
  created_at    DateTime?                       @default(now())
  rankings      rankings                        @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users         users                           @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([ranking_id, round_month, snapshot_type, user_id])
  @@index([user_id])
  @@index([ranking_id, round_month, snapshot_type])
}

model rankings {
  id                  Int                   @id @default(autoincrement())
  name                String
  slug                String                @unique
  description         String?
  is_active           Boolean               @default(true)
  created_at          DateTime?             @default(now())
  blue_point_history  blue_point_history[]
  challenges          challenges[]
  collaborator_rankings collaborator_rankings[]
  ranking_memberships ranking_memberships[]
  ranking_snapshots   ranking_snapshots[]
  round_logs          round_logs[]
  rounds              rounds[]
}

model round_logs {
  id              Int       @id @default(autoincrement())
  ranking_id      Int
  reference_month DateTime
  line_no         Int
  message         String
  created_at      DateTime? @default(now())
  rankings        rankings  @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([ranking_id, reference_month])
}

model rounds {
  id                                         Int           @id @default(autoincrement())
  ranking_id                                 Int?
  title                                      String
  reference_month                            DateTime
  round_opens_at                             DateTime?
  blue_point_opens_at                        DateTime
  blue_point_closes_at                       DateTime?
  open_challenges_at                         DateTime
  open_challenges_end_at                     DateTime?
  matches_deadline                           DateTime
  featured_challenger_id                     Int?
  featured_challenged_id                     Int?
  featured_match_at                          DateTime?
  featured_result                            String?
  updated_by                                 Int?
  created_at                                 DateTime?     @default(now())
  updated_at                                 DateTime?
  status                                     rounds_status @default(open)
  closed_at                                  DateTime?
  challenges                                 challenges[]
  rankings                                   rankings?     @relation(fields: [ranking_id], references: [id], onUpdate: NoAction)
  users_rounds_featured_challenged_idTousers users?        @relation("rounds_featured_challenged_idTousers", fields: [featured_challenged_id], references: [id], onUpdate: NoAction)
  users_rounds_featured_challenger_idTousers users?        @relation("rounds_featured_challenger_idTousers", fields: [featured_challenger_id], references: [id], onUpdate: NoAction)
  users_rounds_updated_byTousers             users?        @relation("rounds_updated_byTousers", fields: [updated_by], references: [id], onUpdate: NoAction)

  @@index([ranking_id])
  @@index([featured_challenged_id])
  @@index([featured_challenger_id])
  @@index([updated_by])
}

model users {
  id                                          Int                   @id @default(autoincrement())
  role                                        users_role            @default(player)
  gender                                      users_gender?
  first_name                                  String
  last_name                                   String
  nickname                                    String?
  email                                       String                @unique
  phone                                       String?
  birth_date                                  DateTime?
  password_hash                               String
  must_reset_password                         Boolean               @default(false)
  password_reset_token                        String?
  password_reset_expires_at                   DateTime?
  sessionToken                                String?               @map("session_token")
  avatarUrl                                   String?               @map("avatar_path")
  created_at                                  DateTime?             @default(now())
  updated_at                                  DateTime?
  blue_point_history                          blue_point_history[]
  challenge_events                            challenge_events[]
  challenges_challenges_challenged_idTousers  challenges[]          @relation("challenges_challenged_idTousers")
  challenges_challenges_challenger_idTousers  challenges[]          @relation("challenges_challenger_idTousers")
  collaborator_rankings                      collaborator_rankings[]
  app_settings                                app_settings[]       @relation("app_settings_user")
  ranking_memberships                         ranking_memberships[]
  ranking_snapshots                           ranking_snapshots[]
  rounds_rounds_featured_challenged_idTousers rounds[]              @relation("rounds_featured_challenged_idTousers")
  rounds_rounds_featured_challenger_idTousers rounds[]              @relation("rounds_featured_challenger_idTousers")
  rounds_rounds_updated_byTousers             rounds[]              @relation("rounds_updated_byTousers")
}

model app_settings {
  id                   Int       @id @default(autoincrement())
  app_name             String?
  logo_url             String?
  favicon_url          String?
  pwa_icon_url         String?
  maintenance_enabled  Boolean   @default(false)
  maintenance_message  String?
  updated_at           DateTime? @default(now())
  updated_by           Int?
  users                users?    @relation("app_settings_user", fields: [updated_by], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([updated_by])
}

enum users_role {
  admin
  collaborator
  player
  member
}

enum challenge_events_event_type {
  created
  updated
  completed
  cancelled
}

enum challenge_penalties_applies_to {
  challenger
  challenged
  both
}

enum users_gender {
  male
  female
  other
}

enum ranking_snapshots_snapshot_type {
  start
  end
}

enum blue_point_history_reason {
  consecutive_challenges
  no_reachable_opponent
  manual
}

enum rounds_status {
  draft
  open
  closed
}

enum challenges_winner {
  challenger
  challenged
}

enum challenges_status {
  scheduled
  accepted
  declined
  completed
  cancelled
}
