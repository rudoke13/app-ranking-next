generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model blue_point_history {
  id         Int                       @id @default(autoincrement()) @db.UnsignedInt
  ranking_id Int                       @db.UnsignedInt
  user_id    Int                       @db.UnsignedInt
  month_key  DateTime                  @db.Date
  reason     blue_point_history_reason
  created_at DateTime?                 @default(now()) @db.Timestamp(0)
  rankings   rankings                  @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_blue_point_ranking")
  users      users                     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_blue_point_user")

  @@unique([ranking_id, user_id, month_key, reason], map: "uniq_blue_point")
  @@index([user_id], map: "fk_blue_point_user")
}

model challenge_events {
  id           Int                         @id @default(autoincrement()) @db.UnsignedInt
  challenge_id Int                         @db.UnsignedInt
  event_type   challenge_events_event_type
  payload      Json?
  created_at   DateTime?                   @default(now()) @db.Timestamp(0)
  created_by   Int?                        @db.UnsignedInt
  challenges   challenges                  @relation(fields: [challenge_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_event_challenge")
  users        users?                      @relation(fields: [created_by], references: [id], onUpdate: NoAction, map: "fk_event_user")

  @@index([challenge_id], map: "fk_event_challenge")
  @@index([created_by], map: "fk_event_user")
}

model challenge_penalties {
  id           Int                            @id @default(autoincrement()) @db.UnsignedInt
  challenge_id Int                            @db.UnsignedInt
  applies_to   challenge_penalties_applies_to
  positions    Int                            @db.SmallInt
  created_at   DateTime?                      @default(now()) @db.Timestamp(0)
  challenges   challenges                     @relation(fields: [challenge_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_penalty_challenge")

  @@index([challenge_id], map: "fk_penalty_challenge")
}

model challenges {
  id                                    Int                   @id @default(autoincrement()) @db.UnsignedInt
  ranking_id                            Int                   @db.UnsignedInt
  challenger_id                         Int                   @db.UnsignedInt
  challenged_id                         Int                   @db.UnsignedInt
  scheduled_for                         DateTime              @db.DateTime(0)
  accepted_at                           DateTime?             @db.DateTime(0)
  declined_at                           DateTime?             @db.DateTime(0)
  decline_reason                        String?               @db.VarChar(255)
  played_at                             DateTime?             @db.DateTime(0)
  result_reported_at                    DateTime?             @db.DateTime(0)
  challenger_games                      Int?                  @db.TinyInt
  challenged_games                      Int?                  @db.TinyInt
  challenger_tiebreak                   Int?                  @db.TinyInt
  challenged_tiebreak                   Int?                  @db.TinyInt
  challenger_walkover                   Boolean?              @default(false)
  challenged_walkover                   Boolean?              @default(false)
  challenger_retired                    Boolean?              @default(false)
  challenged_retired                    Boolean?              @default(false)
  challenger_position_at_challenge      Int?                  @db.UnsignedInt
  challenged_position_at_challenge      Int?                  @db.UnsignedInt
  winner                                challenges_winner?
  notes                                 String?               @db.Text
  penalty_summary                       Json?
  cancelled_by_admin                    Boolean               @default(false)
  status                                challenges_status     @default(scheduled)
  round_id                              Int?                  @db.UnsignedInt
  created_at                            DateTime?             @default(now()) @db.Timestamp(0)
  updated_at                            DateTime?             @db.Timestamp(0)
  challenge_events                      challenge_events[]
  challenge_penalties                   challenge_penalties[]
  users_challenges_challenged_idTousers users                 @relation("challenges_challenged_idTousers", fields: [challenged_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_challenge_challenged")
  users_challenges_challenger_idTousers users                 @relation("challenges_challenger_idTousers", fields: [challenger_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_challenge_challenger")
  rankings                              rankings              @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_challenge_ranking")
  rounds                                rounds?               @relation(fields: [round_id], references: [id], onUpdate: NoAction, map: "fk_challenge_round")

  @@index([challenged_id], map: "fk_challenge_challenged")
  @@index([challenger_id], map: "fk_challenge_challenger")
  @@index([ranking_id], map: "fk_challenge_ranking")
  @@index([round_id], map: "fk_challenge_round")
}

model ranking_memberships {
  id                  Int      @id @default(autoincrement()) @db.UnsignedInt
  ranking_id          Int      @db.UnsignedInt
  user_id             Int      @db.UnsignedInt
  position            Int?     @db.UnsignedInt
  points              Int?     @default(0)
  is_blue_point       Boolean? @default(false)
  is_access_challenge Boolean  @default(false)
  is_locked           Boolean? @default(false)
  is_suspended        Boolean? @default(false)
  license_position    Int?     @db.UnsignedInt
  rankings            rankings @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_membership_ranking")
  users               users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_membership_user")

  @@unique([ranking_id, user_id], map: "uniq_ranking_user")
  @@index([user_id], map: "fk_membership_user")
}

model collaborator_rankings {
  id         Int       @id @default(autoincrement()) @db.UnsignedInt
  user_id    Int       @db.UnsignedInt
  ranking_id Int       @db.UnsignedInt
  created_at DateTime? @default(now()) @db.Timestamp(0)
  rankings   rankings  @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_collab_ranking")
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_collab_user")

  @@unique([user_id, ranking_id], map: "uniq_collab_ranking")
  @@index([ranking_id], map: "fk_collab_ranking")
}

model ranking_snapshots {
  id            Int                             @id @default(autoincrement()) @db.UnsignedInt
  ranking_id    Int                             @db.UnsignedInt
  round_month   DateTime                        @db.Date
  snapshot_type ranking_snapshots_snapshot_type @default(start)
  user_id       Int                             @db.UnsignedInt
  position      Int                             @db.UnsignedInt
  created_at    DateTime?                       @default(now()) @db.Timestamp(0)
  rankings      rankings                        @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_snapshot_ranking")
  users         users                           @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_snapshot_user")

  @@unique([ranking_id, round_month, snapshot_type, user_id], map: "uniq_snapshot")
  @@index([user_id], map: "fk_snapshot_user")
  @@index([ranking_id, round_month, snapshot_type], map: "idx_snapshot_month")
}

model rankings {
  id                  Int                   @id @default(autoincrement()) @db.UnsignedInt
  name                String                @db.VarChar(120)
  slug                String                @unique(map: "slug") @db.VarChar(120)
  description         String?               @db.Text
  is_active           Boolean               @default(true)
  created_at          DateTime?             @default(now()) @db.Timestamp(0)
  blue_point_history  blue_point_history[]
  challenges          challenges[]
  collaborator_rankings collaborator_rankings[]
  ranking_memberships ranking_memberships[]
  ranking_snapshots   ranking_snapshots[]
  round_logs          round_logs[]
  rounds              rounds[]
}

model round_logs {
  id              Int       @id @default(autoincrement()) @db.UnsignedInt
  ranking_id      Int       @db.UnsignedInt
  reference_month DateTime  @db.Date
  line_no         Int       @db.UnsignedInt
  message         String    @db.Text
  created_at      DateTime? @default(now()) @db.Timestamp(0)
  rankings        rankings  @relation(fields: [ranking_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_round_logs_ranking")

  @@index([ranking_id, reference_month], map: "idx_round_logs")
}

model rounds {
  id                                         Int           @id @default(autoincrement()) @db.UnsignedInt
  ranking_id                                 Int?          @db.UnsignedInt
  title                                      String        @db.VarChar(150)
  reference_month                            DateTime      @db.Date
  round_opens_at                             DateTime?     @db.DateTime(0)
  blue_point_opens_at                        DateTime      @db.DateTime(0)
  blue_point_closes_at                       DateTime?     @db.DateTime(0)
  open_challenges_at                         DateTime      @db.DateTime(0)
  open_challenges_end_at                     DateTime?     @db.DateTime(0)
  matches_deadline                           DateTime      @db.DateTime(0)
  featured_challenger_id                     Int?          @db.UnsignedInt
  featured_challenged_id                     Int?          @db.UnsignedInt
  featured_match_at                          DateTime?     @db.DateTime(0)
  featured_result                            String?       @db.VarChar(100)
  updated_by                                 Int?          @db.UnsignedInt
  created_at                                 DateTime?     @default(now()) @db.Timestamp(0)
  updated_at                                 DateTime?     @db.Timestamp(0)
  status                                     rounds_status @default(open)
  closed_at                                  DateTime?     @db.DateTime(0)
  challenges                                 challenges[]
  rankings                                   rankings?     @relation(fields: [ranking_id], references: [id], onUpdate: NoAction, map: "fk_round_ranking")
  users_rounds_featured_challenged_idTousers users?        @relation("rounds_featured_challenged_idTousers", fields: [featured_challenged_id], references: [id], onUpdate: NoAction, map: "fk_round_user_challenged")
  users_rounds_featured_challenger_idTousers users?        @relation("rounds_featured_challenger_idTousers", fields: [featured_challenger_id], references: [id], onUpdate: NoAction, map: "fk_round_user_challenger")
  users_rounds_updated_byTousers             users?        @relation("rounds_updated_byTousers", fields: [updated_by], references: [id], onUpdate: NoAction, map: "fk_round_user_updater")

  @@index([ranking_id], map: "fk_round_ranking")
  @@index([featured_challenged_id], map: "fk_round_user_challenged")
  @@index([featured_challenger_id], map: "fk_round_user_challenger")
  @@index([updated_by], map: "fk_round_user_updater")
}

model users {
  id                                          Int                   @id @default(autoincrement()) @db.UnsignedInt
  role                                        users_role            @default(player)
  gender                                      users_gender?
  first_name                                  String                @db.VarChar(100)
  last_name                                   String                @db.VarChar(100)
  nickname                                    String?               @db.VarChar(100)
  email                                       String                @unique(map: "email") @db.VarChar(190)
  phone                                       String?               @db.VarChar(30)
  birth_date                                  DateTime?             @db.Date
  password_hash                               String                @db.VarChar(255)
  must_reset_password                         Boolean               @default(false)
  password_reset_token                        String?               @db.VarChar(128)
  password_reset_expires_at                   DateTime?             @db.DateTime(0)
  sessionToken                                String?               @map("session_token") @db.VarChar(64)
  avatarUrl                                   String?               @map("avatar_path") @db.VarChar(255)
  created_at                                  DateTime?             @default(now()) @db.Timestamp(0)
  updated_at                                  DateTime?             @db.Timestamp(0)
  blue_point_history                          blue_point_history[]
  challenge_events                            challenge_events[]
  challenges_challenges_challenged_idTousers  challenges[]          @relation("challenges_challenged_idTousers")
  challenges_challenges_challenger_idTousers  challenges[]          @relation("challenges_challenger_idTousers")
  collaborator_rankings                      collaborator_rankings[]
  app_settings                                app_settings[]       @relation("app_settings_user")
  ranking_memberships                         ranking_memberships[]
  ranking_snapshots                           ranking_snapshots[]
  rounds_rounds_featured_challenged_idTousers rounds[]              @relation("rounds_featured_challenged_idTousers")
  rounds_rounds_featured_challenger_idTousers rounds[]              @relation("rounds_featured_challenger_idTousers")
  rounds_rounds_updated_byTousers             rounds[]              @relation("rounds_updated_byTousers")
}

model app_settings {
  id                   Int       @id @default(autoincrement()) @db.UnsignedInt
  app_name             String?   @db.VarChar(150)
  logo_url             String?   @db.VarChar(255)
  favicon_url          String?   @db.VarChar(255)
  pwa_icon_url         String?   @db.VarChar(255)
  maintenance_enabled  Boolean   @default(false)
  maintenance_message  String?   @db.Text
  updated_at           DateTime? @default(now()) @db.Timestamp(0)
  updated_by           Int?      @db.UnsignedInt
  users                users?    @relation("app_settings_user", fields: [updated_by], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "fk_app_settings_user")

  @@index([updated_by], map: "fk_app_settings_user")
}

enum users_role {
  admin
  collaborator
  player
  member
}

enum challenge_events_event_type {
  created
  updated
  completed
  cancelled
}

enum challenge_penalties_applies_to {
  challenger
  challenged
  both
}

enum users_gender {
  male
  female
  other
}

enum ranking_snapshots_snapshot_type {
  start
  end
}

enum blue_point_history_reason {
  consecutive_challenges
  no_reachable_opponent
  manual
}

enum rounds_status {
  draft
  open
  closed
}

enum challenges_winner {
  challenger
  challenged
}

enum challenges_status {
  scheduled
  accepted
  declined
  completed
  cancelled
}
